============================= test session starts =============================
platform win32 -- Python 3.11.9, pytest-8.4.2, pluggy-1.6.0 -- C:\Users\sanal\AppData\Local\Programs\Python\Python311\python.exe
cachedir: .pytest_cache
PySide6 6.7.2 -- Qt runtime 6.7.2 -- Qt compiled 6.7.2
rootdir: D:\github\webos
configfile: pyproject.toml
plugins: anyio-4.3.0, asyncio-1.2.0, mock-3.15.0, qt-4.5.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 5 items

tests/modules/dam/test_backend_gaps.py::test_ai_processors_registration PASSED [ 20%]
tests/modules/dam/test_backend_gaps.py::test_album_crud FAILED           [ 40%]
tests/modules/dam/test_backend_gaps.py::test_graph_links_endpoint FAILED [ 60%]
tests/modules/dam/test_backend_gaps.py::test_full_ai_pipeline_execution PASSED [ 80%]
tests/modules/dam/test_backend_gaps.py::test_search_graph_expansion FAILED [100%]

================================== FAILURES ===================================
_______________________________ test_album_crud _______________________________
  + Exception Group Traceback (most recent call last):
  |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\anyio\_backends\_asyncio.py", line 678, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pytestqt\plugin.py", line 187, in pytest_runtest_call
    |     result = yield
    |              ^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pytest_asyncio\plugin.py", line 474, in runtest
    |     super().runtest()
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pytest_asyncio\plugin.py", line 721, in inner
    |     runner.run(coro, context=context)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\asyncio\runners.py", line 118, in run
    |     return self._loop.run_until_complete(task)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\asyncio\base_events.py", line 654, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "D:\github\webos\tests\modules\dam\test_backend_gaps.py", line 58, in test_album_crud
    |     resp = await client.post("/api/dam/albums", json={"title": "Travel", "description": "Vacation photos"})
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1859, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1540, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1629, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1657, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1694, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1730, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_transports\asgi.py", line 170, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\errors.py", line 186, in __call__
    |     raise exc
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 189, in __call__
    |     with collapse_excgroups():
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\github\webos\src\main.py", line 93, in add_trace_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 165, in call_next
    |     raise app_exc
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 151, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\cors.py", line 83, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py", line 64, in wrapped_app
    |     raise exc
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 758, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 778, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 299, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 79, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py", line 64, in wrapped_app
    |     raise exc
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 74, in app
    |     response = await func(request)
    |                ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py", line 299, in app
    |     raise e
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py", line 294, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py", line 191, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\github\webos\src\modules\dam\router.py", line 200, in create_album
    |     album = Album(
    |             ^^^^^
    | NameError: name 'Album' is not defined
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\github\webos\tests\modules\dam\test_backend_gaps.py", line 58, in test_album_crud
    resp = await client.post("/api/dam/albums", json={"title": "Travel", "description": "Vacation photos"})
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1859, in post
    return await self.request(
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1540, in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1629, in send
    response = await self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1657, in _send_handling_auth
    response = await self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1694, in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1730, in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_transports\asgi.py", line 170, in handle_async_request
    await self.app(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\errors.py", line 186, in __call__
    raise exc
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 189, in __call__
    with collapse_excgroups():
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_utils.py", line 93, in collapse_excgroups
    raise exc
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 191, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\github\webos\src\main.py", line 93, in add_trace_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 165, in call_next
    raise app_exc
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 151, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\cors.py", line 83, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py", line 64, in wrapped_app
    raise exc
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 778, in app
    await route.handle(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 299, in handle
    await self.app(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py", line 64, in wrapped_app
    raise exc
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 74, in app
    response = await func(request)
               ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py", line 299, in app
    raise e
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py", line 294, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\github\webos\src\modules\dam\router.py", line 200, in create_album
    album = Album(
            ^^^^^
NameError: name 'Album' is not defined

During handling of the above exception, another exception occurred:

client = <httpx.AsyncClient object at 0x000001AB6BF2ECD0>, mock_db = None

    @pytest.mark.asyncio
    async def test_album_crud(client, mock_db):
        # 1. Create Album
>       resp = await client.post("/api/dam/albums", json={"title": "Travel", "description": "Vacation photos"})
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\modules\dam\test_backend_gaps.py:58: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py:1859: in post
    return await self.request(
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py:1629: in send
    response = await self._send_handling_auth(
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_transports\asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py:189: in __call__
    with collapse_excgroups():
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_utils.py:93: in collapse_excgroups
    raise exc
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py:191: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\main.py:93: in add_trace_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py:165: in call_next
    raise app_exc
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py:151: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\cors.py:83: in __call__
    await self.app(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py:64: in wrapped_app
    raise exc
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py:758: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py:778: in app
    await route.handle(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py:299: in handle
    await self.app(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py:79: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py:64: in wrapped_app
    raise exc
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py:74: in app
    response = await func(request)
               ^^^^^^^^^^^^^^^^^^^
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py:299: in app
    raise e
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py:294: in app
    raw_response = await run_endpoint_function(
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

create = AlbumCreate(title='Travel', description='Vacation photos')

    @router.post("/albums", response_model=AlbumResponse, status_code=201)
    async def create_album(create: AlbumCreate):
        """
        Creates a new virtual collection.
        """
        settings = get_settings()
        owner_id = settings.system_owner_id
    
>       album = Album(
                ^^^^^
            title=create.title,
            description=create.description,
            owner_id=owner_id
        )
E       NameError: name 'Album' is not defined

src\modules\dam\router.py:200: NameError
---------------------------- Captured stderr setup ----------------------------
2026-02-21 06:35:42.743 | WARNING  | src.modules.dam.drivers.video_driver:__init__:19 - VideoDriver: 'ffprobe' not found in system PATH. Video metadata extraction is disabled.
2026-02-21 06:35:42.743 | DEBUG    | src.modules.dam.drivers.manager:register:21 - Registered Asset Driver: ImageDriver for type 'image'
2026-02-21 06:35:42.743 | DEBUG    | src.modules.dam.drivers.manager:register:21 - Registered Asset Driver: VideoDriver for type 'video'
2026-02-21 06:35:42.743 | DEBUG    | src.modules.dam.drivers.manager:register:21 - Registered Asset Driver: AudioDriver for type 'audio'
2026-02-21 06:35:42.743 | DEBUG    | src.modules.dam.drivers.manager:register:21 - Registered Asset Driver: DocumentDriver for type 'document'
2026-02-21 06:35:42.743 | INFO     | src.modules.dam.hooks:register_services:104 - DAM: Registered AssetDriverManager containing 4 drivers.
2026-02-21 06:35:43.086 | INFO     | src.modules.dam.hooks:register_services:131 - DAM: Registered PipelineOrchestrator with 6 processors.
2026-02-21 06:35:43.086 | DEBUG    | src.core.event_bus:subscribe:27 - Subscribed to event: dam:asset:ingested
__________________________ test_graph_links_endpoint __________________________
  + Exception Group Traceback (most recent call last):
  |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\anyio\_backends\_asyncio.py", line 678, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |                              ^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pytestqt\plugin.py", line 187, in pytest_runtest_call
    |     result = yield
    |              ^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pytest_asyncio\plugin.py", line 474, in runtest
    |     super().runtest()
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |           ^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\pytest_asyncio\plugin.py", line 721, in inner
    |     runner.run(coro, context=context)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\asyncio\runners.py", line 118, in run
    |     return self._loop.run_until_complete(task)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\asyncio\base_events.py", line 654, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "D:\github\webos\tests\modules\dam\test_backend_gaps.py", line 91, in test_graph_links_endpoint
    |     resp = await client.get(f"/api/dam/assets/{aid1}/links")
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1768, in get
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1540, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1629, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1657, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1694, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1730, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_transports\asgi.py", line 170, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\errors.py", line 186, in __call__
    |     raise exc
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 189, in __call__
    |     with collapse_excgroups():
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\github\webos\src\main.py", line 93, in add_trace_id
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 165, in call_next
    |     raise app_exc
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 151, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\cors.py", line 83, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py", line 64, in wrapped_app
    |     raise exc
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 758, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 778, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 299, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 79, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py", line 64, in wrapped_app
    |     raise exc
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 74, in app
    |     response = await func(request)
    |                ^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py", line 299, in app
    |     raise e
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py", line 294, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py", line 191, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "D:\github\webos\src\modules\dam\router.py", line 175, in get_asset_links
    |     links = await Link.find(
    |                   ^^^^
    | NameError: name 'Link' is not defined
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\github\webos\tests\modules\dam\test_backend_gaps.py", line 91, in test_graph_links_endpoint
    resp = await client.get(f"/api/dam/assets/{aid1}/links")
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1768, in get
    return await self.request(
           ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1540, in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1629, in send
    response = await self._send_handling_auth(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1657, in _send_handling_auth
    response = await self._send_handling_redirects(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1694, in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py", line 1730, in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_transports\asgi.py", line 170, in handle_async_request
    await self.app(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\errors.py", line 186, in __call__
    raise exc
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 189, in __call__
    with collapse_excgroups():
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\contextlib.py", line 158, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_utils.py", line 93, in collapse_excgroups
    raise exc
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 191, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\github\webos\src\main.py", line 93, in add_trace_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 165, in call_next
    raise app_exc
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py", line 151, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\cors.py", line 83, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py", line 64, in wrapped_app
    raise exc
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 778, in app
    await route.handle(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 299, in handle
    await self.app(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 79, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py", line 64, in wrapped_app
    raise exc
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py", line 74, in app
    response = await func(request)
               ^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py", line 299, in app
    raise e
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py", line 294, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\github\webos\src\modules\dam\router.py", line 175, in get_asset_links
    links = await Link.find(
                  ^^^^
NameError: name 'Link' is not defined

During handling of the above exception, another exception occurred:

client = <httpx.AsyncClient object at 0x000001AB6FF82DD0>, mock_db = None

    @pytest.mark.asyncio
    async def test_graph_links_endpoint(client, mock_db):
        aid1 = PydanticObjectId()
        aid2 = PydanticObjectId()
    
        link = Link(source_id=aid1, target_id=aid2, relation="visually_similar_to", weight=0.9)
        await link.insert()
    
>       resp = await client.get(f"/api/dam/assets/{aid1}/links")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\modules\dam\test_backend_gaps.py:91: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py:1768: in get
    return await self.request(
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py:1629: in send
    response = await self._send_handling_auth(
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\httpx\_transports\asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py:189: in __call__
    with collapse_excgroups():
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_utils.py:93: in collapse_excgroups
    raise exc
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py:191: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\main.py:93: in add_trace_id
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py:165: in call_next
    raise app_exc
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\base.py:151: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\cors.py:83: in __call__
    await self.app(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\middleware\exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py:64: in wrapped_app
    raise exc
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py:758: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py:778: in app
    await route.handle(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py:299: in handle
    await self.app(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py:79: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py:64: in wrapped_app
    raise exc
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\routing.py:74: in app
    response = await func(request)
               ^^^^^^^^^^^^^^^^^^^
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py:299: in app
    raise e
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py:294: in app
    raw_response = await run_endpoint_function(
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\fastapi\routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

asset_id = '6999362021e945e8f6ce9c98'

    @router.get("/assets/{asset_id}/links", response_model=List[LinkResponse])
    async def get_asset_links(asset_id: str):
        """
        Returns all relationships (links) for a given asset.
        """
>       links = await Link.find(
                      ^^^^
            (Link.source_id == PydanticObjectId(asset_id)) |
            (Link.target_id == PydanticObjectId(asset_id))
        ).to_list()
E       NameError: name 'Link' is not defined

src\modules\dam\router.py:175: NameError
---------------------------- Captured stderr setup ----------------------------
2026-02-21 06:35:43.931 | WARNING  | src.modules.dam.drivers.video_driver:__init__:19 - VideoDriver: 'ffprobe' not found in system PATH. Video metadata extraction is disabled.
2026-02-21 06:35:43.931 | DEBUG    | src.modules.dam.drivers.manager:register:21 - Registered Asset Driver: ImageDriver for type 'image'
2026-02-21 06:35:43.931 | DEBUG    | src.modules.dam.drivers.manager:register:21 - Registered Asset Driver: VideoDriver for type 'video'
2026-02-21 06:35:43.931 | DEBUG    | src.modules.dam.drivers.manager:register:21 - Registered Asset Driver: AudioDriver for type 'audio'
2026-02-21 06:35:43.931 | DEBUG    | src.modules.dam.drivers.manager:register:21 - Registered Asset Driver: DocumentDriver for type 'document'
2026-02-21 06:35:43.931 | INFO     | src.modules.dam.hooks:register_services:104 - DAM: Registered AssetDriverManager containing 4 drivers.
2026-02-21 06:35:44.267 | INFO     | src.modules.dam.hooks:register_services:131 - DAM: Registered PipelineOrchestrator with 6 processors.
2026-02-21 06:35:44.267 | DEBUG    | src.core.event_bus:subscribe:27 - Subscribed to event: dam:asset:ingested
_________________________ test_search_graph_expansion _________________________

client = <httpx.AsyncClient object at 0x000001AB6F8932D0>, mock_db = None

    @pytest.mark.asyncio
    async def test_search_graph_expansion(client, mock_db):
        # Create seeds and linked assets
        aid1 = PydanticObjectId() # Result from keyword/vector
        aid2 = PydanticObjectId() # Neighbor in graph
    
        asset1 = Asset(
            id=aid1, filename="beach.jpg", storage_urn="fs://local/beach.jpg",
            owner_id=TEST_OWNER_ID, title="Beach", asset_types=["image"]
        )
        asset2 = Asset(
            id=aid2, filename="ocean.jpg", storage_urn="fs://local/ocean.jpg",
            owner_id=TEST_OWNER_ID, title="Ocean", asset_types=["image"]
        )
        await asset1.insert()
        await asset2.insert()
    
        # Link them
        link = Link(source_id=aid1, target_id=aid2, relation="visually_similar_to")
        await link.insert()
    
        from src.modules.dam.services.unified_search import UnifiedSearchService
        search_svc = ServiceRegistry.get(UnifiedSearchService)
    
        # Mock keyword/vector to return aid1
        with patch.object(UnifiedSearchService, "_keyword_channel", return_value=[str(aid1)]), \
             patch.object(UnifiedSearchService, "_vector_channel", return_value=[]):
    
            from src.modules.dam.schemas.search import SearchRequest, AssetFilter
            req = SearchRequest(query="Beach", filter=AssetFilter(owner_id=TEST_OWNER_ID))
>           result = await search_svc.search(req)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\modules\dam\test_backend_gaps.py:158: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\modules\dam\services\unified_search.py:44: in search
    graph_hits = await self._graph_extension_channel(seeds) if seeds else []
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <src.modules.dam.services.unified_search.UnifiedSearchService object at 0x000001AB6F891810>
seed_ids = ['6999362121e945e8f6ce9c9c']

    async def _graph_extension_channel(self, seed_ids: List[str]) -> List[str]:
        """
        Finds assets linked to the primary hits via the Knowledge Graph.
        """
        from src.modules.dam.models import Link
    
        seeds = [PydanticObjectId(sid) for sid in seed_ids]
    
        # Find links where these seeds are either source or target
        links = await Link.find(
>           (Link.source_id.in_(seeds)) | (Link.target_id.in_(seeds))
             ^^^^^^^^^^^^^^^^^^^^^^^^^
        ).to_list()
E       TypeError: 'ExpressionField' object is not callable

src\modules\dam\services\unified_search.py:139: TypeError
---------------------------- Captured stderr setup ----------------------------
2026-02-21 06:35:45.000 | WARNING  | src.modules.dam.drivers.video_driver:__init__:19 - VideoDriver: 'ffprobe' not found in system PATH. Video metadata extraction is disabled.
2026-02-21 06:35:45.000 | DEBUG    | src.modules.dam.drivers.manager:register:21 - Registered Asset Driver: ImageDriver for type 'image'
2026-02-21 06:35:45.000 | DEBUG    | src.modules.dam.drivers.manager:register:21 - Registered Asset Driver: VideoDriver for type 'video'
2026-02-21 06:35:45.000 | DEBUG    | src.modules.dam.drivers.manager:register:21 - Registered Asset Driver: AudioDriver for type 'audio'
2026-02-21 06:35:45.000 | DEBUG    | src.modules.dam.drivers.manager:register:21 - Registered Asset Driver: DocumentDriver for type 'document'
2026-02-21 06:35:45.001 | INFO     | src.modules.dam.hooks:register_services:104 - DAM: Registered AssetDriverManager containing 4 drivers.
2026-02-21 06:35:45.353 | INFO     | src.modules.dam.hooks:register_services:131 - DAM: Registered PipelineOrchestrator with 6 processors.
2026-02-21 06:35:45.353 | DEBUG    | src.core.event_bus:subscribe:27 - Subscribed to event: dam:asset:ingested
============================== warnings summary ===============================
C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\formparsers.py:12
  C:\Users\sanal\AppData\Local\Programs\Python\Python311\Lib\site-packages\starlette\formparsers.py:12: PendingDeprecationWarning: Please use `import python_multipart` instead.
    import multipart

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/modules/dam/test_backend_gaps.py::test_album_crud - NameError: name 'Album' is not defined
FAILED tests/modules/dam/test_backend_gaps.py::test_graph_links_endpoint - NameError: name 'Link' is not defined
FAILED tests/modules/dam/test_backend_gaps.py::test_search_graph_expansion - TypeError: 'ExpressionField' object is not callable
=================== 3 failed, 2 passed, 1 warning in 8.16s ====================
